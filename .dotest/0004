From 0dfe543d72750abeed2e5e84ea00524a562507c4 Mon Sep 17 00:00:00 2001
From: McCabe Maxsted <hakushakukun@gmail.com>
Date: Thu, 11 Jun 2009 04:28:24 -0700
Subject: Added Link/Unlink buttons to the Tools floater

---
 ChangeLog.txt                                      |    7 ++
 linden/indra/newview/llfloatertools.cpp            |   97 ++++++++++++++++++++
 linden/indra/newview/llfloatertools.h              |    7 ++
 .../skins/default/xui/en-us/floater_tools.xml      |   58 +++++++-----
 4 files changed, 143 insertions(+), 26 deletions(-)

diff --git a/ChangeLog.txt b/ChangeLog.txt
index 1ba82f64b800c829d26043a4d0190af3ca55da9b..8d7ea8a60b0cb859cb8fd252830201e38b34b990 100644
--- a/ChangeLog.txt
+++ b/ChangeLog.txt
@@ -14,6 +14,13 @@
 		new file:   linden/indra/newview/skins/default/xui/en-us/panel_mini_map.xml
 		
 
+	* Added Link/Unlink buttons to the Tools floater.
+	
+		modified:   linden/indra/newview/llfloatertools.cpp
+		modified:   linden/indra/newview/llfloatertools.h
+		modified:   linden/indra/newview/skins/default/xui/en-us/floater_tools.xml
+
+
 2009-06-10  McCabe Maxsted  <hakushakukun@gmail.com>
 
 	* Fixed Communicate window not toggling from menu.
diff --git a/linden/indra/newview/llfloatertools.cpp b/linden/indra/newview/llfloatertools.cpp
index 73b606109323b623a8006906d90584d6c58b2f83..84a1edc445950867666d28374cb9ba8003bb38c2 100644
--- a/linden/indra/newview/llfloatertools.cpp
+++ b/linden/indra/newview/llfloatertools.cpp
@@ -46,6 +46,7 @@
 #include "llfloateropenobject.h"
 #include "llfocusmgr.h"
 #include "llmenugl.h"
+#include "llnotify.h"
 #include "llpanelcontents.h"
 #include "llpanelface.h"
 #include "llpanelland.h"
@@ -235,6 +236,11 @@ BOOL	LLFloaterTools::postBuild()
 	mTextGridMode = getChild<LLTextBox>("text ruler mode");
 	mComboGridMode = getChild<LLComboBox>("combobox grid mode");
 	childSetCommitCallback("combobox grid mode",commit_grid_mode, this);
+	mBtnLink = getChild<LLButton>("link_btn");
+	childSetAction("link_btn",onClickLink, this);
+	mBtnUnlink = getChild<LLButton>("unlink_btn");
+	childSetAction("unlink_btn",onClickUnlink, this);
+
 	//
 	// Create Buttons
 	//
@@ -387,6 +393,9 @@ LLFloaterTools::LLFloaterTools()
 	mBtnDuplicate(NULL),
 	mBtnDuplicateInPlace(NULL),
 
+	mBtnLink(NULL),
+	mBtnUnlink(NULL),
+
 	mComboTreesGrass(NULL),
 	mCheckSticky(NULL),
 	mCheckCopySelection(NULL),
@@ -661,6 +670,44 @@ void LLFloaterTools::updatePopup(LLCoordGL center, MASK mask)
 	if (mCheckStretchUniform) mCheckStretchUniform->setVisible( edit_visible );
 	if (mCheckStretchTexture) mCheckStretchTexture->setVisible( edit_visible );
 
+	if (mBtnLink) mBtnLink->setVisible( edit_visible );
+	if (mBtnUnlink) mBtnUnlink->setVisible( edit_visible );
+
+	// Check to see if we can link things
+	bool can_link = false;
+	if (!gSavedSettings.getBOOL("EditLinkedParts"))
+	{
+		if(LLSelectMgr::getInstance()->selectGetAllRootsValid() && LLSelectMgr::getInstance()->getSelection()->getRootObjectCount() >= 2)
+		{
+			struct f : public LLSelectedObjectFunctor
+			{
+				virtual bool apply(LLViewerObject* object)
+				{
+					return object->permModify();
+				}
+			}
+			func;
+			const bool firstonly = true;
+			can_link = LLSelectMgr::getInstance()->getSelection()->applyToRootObjects(&func, firstonly);
+		}
+	}
+	mBtnLink->setEnabled(can_link);
+
+	// Check to see if we can unlink things
+	bool can_unlink = false;
+	if (LLSelectMgr::getInstance()->selectGetAllRootsValid() &&
+		LLSelectMgr::getInstance()->getSelection()->getFirstEditableObject() &&
+		!LLSelectMgr::getInstance()->getSelection()->getFirstEditableObject()->isAttachment())
+	{
+		if (LLSelectMgr::getInstance()->getSelection()->getRootObjectCount() != 
+			LLSelectMgr::getInstance()->getSelection()->getObjectCount())
+		{
+			can_unlink = true;
+		}
+	}
+	mBtnUnlink->setEnabled(can_unlink);
+
+
 	// Create buttons
 	BOOL create_visible = (tool == LLToolCompCreate::getInstance());
 
@@ -1109,3 +1156,53 @@ void LLFloaterTools::onSelectTreesGrass(LLUICtrl*, void*)
 		gSavedSettings.setString("LastGrass", selected);
 	}  
 }
+
+// static
+void LLFloaterTools::onClickLink(void* data)
+{
+	if(!LLSelectMgr::getInstance()->selectGetAllRootsValid())
+	{
+		LLNotifyBox::showXml("UnableToLinkWhileDownloading");
+		return;
+	}
+ 
+	S32 object_count = LLSelectMgr::getInstance()->getSelection()->getObjectCount();
+	if (object_count > MAX_CHILDREN_PER_TASK + 1)
+	{
+		LLStringUtil::format_map_t args;
+		args["[COUNT]"] = llformat("%d", object_count);
+		int max = MAX_CHILDREN_PER_TASK+1;
+		args["[MAX]"] = llformat("%d", max);
+		gViewerWindow->alertXml("UnableToLinkObjects", args);
+		return;
+	}
+ 
+	if(LLSelectMgr::getInstance()->getSelection()->getRootObjectCount() < 2)
+	{
+		gViewerWindow->alertXml("CannotLinkIncompleteSet");
+		return;
+	}
+	if(!LLSelectMgr::getInstance()->selectGetRootsModify())
+	{
+		gViewerWindow->alertXml("CannotLinkModify");
+		return;
+	}
+	LLUUID owner_id;
+	std::string owner_name;
+	if(!LLSelectMgr::getInstance()->selectGetOwner(owner_id, owner_name))
+	{
+	  // we don't actually care if you're the owner, but novices are
+	  // the most likely to be stumped by this one, so offer the
+	  // easiest and most likely solution.
+	  gViewerWindow->alertXml("CannotLinkDifferentOwners");
+	  return;
+	}
+	LLSelectMgr::getInstance()->sendLink();
+	return;
+}
+
+// static
+void LLFloaterTools::onClickUnlink(void* data)
+{
+	LLSelectMgr::getInstance()->sendDelink();
+}
diff --git a/linden/indra/newview/llfloatertools.h b/linden/indra/newview/llfloatertools.h
index 360b1df061e59e4e0c9c1bc6085655323f44ed2a..8f8897776c87f603fe00c941d74b0381dfbffc7c 100644
--- a/linden/indra/newview/llfloatertools.h
+++ b/linden/indra/newview/llfloatertools.h
@@ -102,6 +102,7 @@ public:
 	virtual void onFocusReceived();
 	static void setEditTool(void* data);
 	void saveLastTool();
+
 private:
 	static void setObjectType( void* data );
 	
@@ -109,6 +110,9 @@ private:
 
 	static void onClickGridOptions(void* data);
 
+	static void onClickLink(void* data);
+	static void onClickUnlink(void* data);
+
 public:
 
 	LLButton		*mBtnFocus;
@@ -152,6 +156,9 @@ public:
 	LLButton	*mBtnDuplicate;
 	LLButton	*mBtnDuplicateInPlace;
 
+	LLButton	*mBtnLink;
+	LLButton	*mBtnUnlink;
+
 	// Create buttons
 	LLComboBox		*mComboTreesGrass;
 	LLCheckBoxCtrl	*mCheckSticky;
diff --git a/linden/indra/newview/skins/default/xui/en-us/floater_tools.xml b/linden/indra/newview/skins/default/xui/en-us/floater_tools.xml
index b6496143f39d2da908dcb3c2e668d72d4ac017cb..18d56b401603a8f9e86d7e2d879e0b92c22896c1 100644
--- a/linden/indra/newview/skins/default/xui/en-us/floater_tools.xml
+++ b/linden/indra/newview/skins/default/xui/en-us/floater_tools.xml
@@ -79,43 +79,49 @@
 	<check_box bottom_delta="-15" follows="left|top" font="SansSerifSmall" height="16"
 	     initial_value="false" label="Select Faces to Texture" left="4" mouse_opaque="true"
 	     name="radio select face" radio_style="true" width="114" />
-	<check_box bottom_delta="-19" control_name="EditLinkedParts" follows="left|top"
-	     font="SansSerifSmall" height="16" initial_value="false"
-	     label="Edit linked parts" left="4" mouse_opaque="true"
-	     name="checkbox edit linked parts" width="114" />
-	<text bg_visible="false" border_drop_shadow_visible="false" border_visible="false"
+  <check_box bottom_delta="-22" control_name="SnapEnabled" follows="left|top"
+	     font="SansSerifSmall" height="16" initial_value="true" label="Use Grid"
+	     left_delta="0" mouse_opaque="true" name="checkbox snap to grid" width="134" />
+  <button bottom_delta="0" follows="left|top" font="SansSerifSmall" halign="center"
+	     height="16" label="Options..." label_selected="Options..." left_delta="75"
+	     mouse_opaque="true" name="Options..." scale_image="TRUE" width="80" />
+  <text bg_visible="false" border_drop_shadow_visible="false" border_visible="false"
 	     bottom_delta="-20" drop_shadow_visible="true" follows="left|top"
 	     font="SansSerifSmall" h_pad="0" halign="left" height="14" left="6"
 	     mouse_opaque="true" name="text ruler mode" v_pad="0" width="68">
-		Ruler mode:
-	</text>
-	<combo_box allow_text_entry="false" bottom_delta="-4" follows="left|top" height="20"
+    Ruler mode:
+  </text>
+  <combo_box allow_text_entry="false" bottom_delta="-4" follows="left|top" height="20"
 	     left_delta="74" max_chars="20" mouse_opaque="true"
 	     name="combobox grid mode" width="86">
-		<combo_item name="World" value="World">
-			World
-		</combo_item>
-		<combo_item name="Local" value="Local">
-			Local
-		</combo_item>
-		<combo_item name="Reference" value="Reference">
-			Reference
-		</combo_item>
-	</combo_box>
-	<check_box bottom="-70" control_name="ScaleUniform" follows="left|top"
+    <combo_item name="World" value="World">
+      World
+    </combo_item>
+    <combo_item name="Local" value="Local">
+      Local
+    </combo_item>
+    <combo_item name="Reference" value="Reference">
+      Reference
+    </combo_item>
+  </combo_box>
+  <check_box bottom="-70" control_name="ScaleUniform" follows="left|top"
 	     font="SansSerifSmall" height="16" initial_value="false"
 	     label="Stretch Both Sides" left="143" mouse_opaque="true"
 	     name="checkbox uniform" width="134" />
-	<check_box bottom_delta="-15" control_name="ScaleStretchTextures" follows="left|top"
+  <check_box bottom_delta="-15" control_name="ScaleStretchTextures" follows="left|top"
 	     font="SansSerifSmall" height="16" initial_value="true"
 	     label="Stretch Textures" left_delta="0" mouse_opaque="true"
 	     name="checkbox stretch textures" width="134" />
-	<check_box bottom_delta="-19" control_name="SnapEnabled" follows="left|top"
-	     font="SansSerifSmall" height="16" initial_value="true" label="Use Grid"
-	     left_delta="0" mouse_opaque="true" name="checkbox snap to grid" width="134" />
-	<button bottom_delta="-14" follows="left|top" font="SansSerifSmall" halign="center"
-	     height="16" label="Options..." label_selected="Options..." left_delta="20"
-	     mouse_opaque="true" name="Options..." scale_image="TRUE" width="80" />
+  <check_box bottom_delta="-15" control_name="EditLinkedParts" follows="left|top"
+	     font="SansSerifSmall" height="16" initial_value="false"
+	     label="Edit linked parts" left="143" mouse_opaque="true"
+	     name="checkbox edit linked parts" width="114" />
+  <button bottom_delta="-18" follows="left|top" font="SansSerifSmall"
+          halign="center" height="18" label="Link" label_selected="Link"
+          right="-5" mouse_opaque="true" name="link_btn" width="78" />
+  <button bottom_delta="-20" follows="left|top" font="SansSerifSmall"
+          halign="center" height="18" label="Unlink" label_selected="Unlink"
+          right="-5" mouse_opaque="true" name="unlink_btn" width="78" />
 
 <!-- Help text -->
 
-- 
1.5.6.5


